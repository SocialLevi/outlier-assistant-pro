<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Outlier Help</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .hidden {
            display: none;
        }
        .spinner {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body class="h-full text-white bg-gray-900">
    <!-- Full screen background container for the login page -->
    <div id="auth-background-container" class="fixed inset-0 z-0 transition-opacity duration-1000 opacity-0">
        <div class="absolute inset-0 bg-black/60"></div> <!-- Dark overlay -->
        <img id="auth-bg-image" src="" alt="Dynamic background" class="w-full h-full object-cover">
    </div>

    <div id="app" class="relative z-10 flex items-center justify-center min-h-full p-4 sm:p-6 lg:p-8">

        <!-- Loading Spinner -->
        <div id="loading-spinner" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
            <div class="spinner h-16 w-16 border-4 border-gray-600 rounded-full"></div>
        </div>

        <!-- Auth Section -->
        <div id="auth-section" class="hidden w-full max-w-md space-y-8">
            <div class="relative z-10 text-center">
                <h2 class="text-4xl font-bold tracking-tight text-white">Welcome to Outlier Help</h2>
                <p class="mt-2 text-sm text-gray-300">
                    Sign in to access your dashboard
                </p>
            </div>
            <div class="bg-black/20 backdrop-blur-xl border border-white/10 p-8 rounded-2xl shadow-2xl space-y-6 relative z-10">
                <!-- Auth Forms: Login / Signup Toggle -->
                <div id="login-form">
                     <input id="login-email" type="email" autocomplete="email" required class="block w-full rounded-md border-0 bg-white/10 p-3 text-white placeholder:text-gray-300 focus:ring-2 focus:ring-inset focus:ring-indigo-500 sm:text-sm" placeholder="Email address">
                     <div class="relative mt-4">
                        <input id="login-password" type="password" autocomplete="current-password" required class="block w-full rounded-md border-0 bg-white/10 p-3 pr-10 text-white placeholder:text-gray-300 focus:ring-2 focus:ring-inset focus:ring-indigo-500 sm:text-sm" placeholder="Password">
                        <button type="button" id="login-password-toggle" class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-white">
                           <svg id="login-eye-icon" class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639l4.43-7.086a1.012 1.012 0 011.633 0l4.43 7.086a1.012 1.012 0 010 .639l-4.43 7.086a1.012 1.012 0 01-1.633 0l-4.43-7.086z" />
                              <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                           </svg>
                           <svg id="login-eye-slash-icon" class="h-5 w-5 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.243 4.243L6.228 6.228" />
                           </svg>
                        </button>
                     </div>
                      <div class="text-right text-sm mt-2">
                        <a href="#" id="forgot-password-link" class="font-medium text-indigo-400 hover:text-indigo-300">Forgot password?</a>
                    </div>
                     <button id="login-button" class="mt-4 flex w-full justify-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600 transition-all duration-300 transform hover:scale-105">Sign in</button>
                </div>
                 <div id="signup-form" class="hidden">
                     <input id="signup-email" type="email" autocomplete="email" required class="block w-full rounded-md border-0 bg-white/10 p-3 text-white placeholder:text-gray-300 focus:ring-2 focus:ring-inset focus:ring-indigo-500 sm:text-sm" placeholder="Email address">
                     <div class="relative mt-4">
                        <input id="signup-password" type="password" autocomplete="new-password" required class="block w-full rounded-md border-0 bg-white/10 p-3 pr-10 text-white placeholder:text-gray-300 focus:ring-2 focus:ring-inset focus:ring-indigo-500 sm:text-sm" placeholder="Password">
                         <button type="button" id="signup-password-toggle" class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-white">
                           <svg id="signup-eye-icon" class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639l4.43-7.086a1.012 1.012 0 011.633 0l4.43 7.086a1.012 1.012 0 010 .639l-4.43 7.086a1.012 1.012 0 01-1.633 0l-4.43-7.086z" />
                              <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                           </svg>
                           <svg id="signup-eye-slash-icon" class="h-5 w-5 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.243 4.243L6.228 6.228" />
                           </svg>
                        </button>
                     </div>
                     <button id="signup-button" class="mt-6 flex w-full justify-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600 transition-all duration-300 transform hover:scale-105">Create Account</button>
                </div>

                 <div id="forgot-password-form" class="hidden">
                    <p class="text-center text-gray-300 mb-4">Enter your email to receive a password reset link.</p>
                     <input id="reset-email" type="email" autocomplete="email" required class="block w-full rounded-md border-0 bg-white/10 p-3 text-white placeholder:text-gray-300 focus:ring-2 focus:ring-inset focus:ring-indigo-500 sm:text-sm" placeholder="Email address">
                     <button id="send-reset-button" class="mt-6 flex w-full justify-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600 transition-all duration-300 transform hover:scale-105">Send Reset Link</button>
                    <div class="text-center text-sm mt-4">
                        <a href="#" id="back-to-login-link" class="font-medium text-indigo-400 hover:text-indigo-300">Back to Sign In</a>
                    </div>
                </div>

                <div class="text-center text-sm">
                    <a href="#" id="toggle-auth" class="font-medium text-indigo-400 hover:text-indigo-300">Don't have an account? Sign up</a>
                </div>

                <div class="relative">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-gray-600"></div>
                    </div>
                    <div class="relative flex justify-center text-sm">
                        <span class="bg-gray-800 px-2 text-gray-400" style="background-color: transparent;">Or continue with</span>
                    </div>
                </div>

                <div>
                    <button id="google-signin-button" class="flex w-full items-center justify-center gap-3 rounded-md bg-white/90 px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-white focus-visible:ring-transparent transition-all duration-300 transform hover:scale-105">
                        <svg class="h-5 w-5" aria-hidden="true" viewBox="0 0 24 24">
                            <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                            <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                            <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z" fill="#FBBC05"/>
                            <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                            <path d="M1 1h22v22H1z" fill="none"/>
                        </svg>
                        <span>Continue with Google</span>
                    </button>
                </div>
            </div>
             <p id="auth-error" class="mt-2 text-center text-sm text-red-400"></p>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard-section" class="hidden w-full h-full">
            <div class="flex flex-col h-full max-w-7xl mx-auto">
                <!-- Header -->
                <header class="bg-gray-800 shadow-md rounded-b-lg">
                    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
                        <div class="flex h-16 items-center justify-between">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                   <span class="text-xl font-bold text-white">Outlier Help</span>
                                </div>
                                <div class="hidden md:block">
                                    <div class="ml-10 flex items-baseline space-x-4">
                                        <a href="#about" class="nav-link bg-gray-900 text-white rounded-md px-3 py-2 text-sm font-medium">About Us</a>
                                        <a href="#menu" class="nav-link text-gray-300 hover:bg-gray-700 hover:text-white rounded-md px-3 py-2 text-sm font-medium">Menu</a>
                                        <a href="#projects" class="nav-link text-gray-300 hover:bg-gray-700 hover:text-white rounded-md px-3 py-2 text-sm font-medium">Projects</a>
                                    </div>
                                </div>
                            </div>
                            <div class="hidden md:block">
                                <div class="ml-4 flex items-center md:ml-6">
                                    <span id="user-email" class="text-gray-400 text-sm mr-4"></span>
                                    <button id="signout-button" class="rounded-full bg-gray-800 p-1 text-gray-400 hover:text-white focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2 focus:ring-offset-gray-800">
                                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                                          <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </header>

                <!-- Main Content -->
                <main class="flex-grow py-8">
                    <div id="page-content" class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
                        <!-- Content will be injected here -->
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- Page Content Templates -->
    <template id="about-template">
        <div class="bg-gray-800 p-8 rounded-lg shadow-lg">
            <h1 class="text-3xl font-bold tracking-tight text-white">About Outlier Help</h1>
            <p class="mt-4 text-gray-300">Outlier Help is a platform dedicated to connecting skilled individuals with unique and challenging projects. We believe in fostering a community of problem-solvers and innovators.</p>
            <p class="mt-2 text-gray-300">Our mission is to provide a space where talent can be tested, proven, and applied to meaningful work. By passing our evaluations, you demonstrate your readiness to tackle complex tasks and join an elite group of professionals.</p>
        </div>
    </template>

    <template id="menu-template">
        <div class="bg-gray-800 p-8 rounded-lg shadow-lg">
            <h1 class="text-3xl font-bold tracking-tight text-white">Menu</h1>
            <p class="mt-4 text-gray-300">Navigate through the platform using the links in the header. Here you can find information about us, explore the menu options, and access the project evaluation section.</p>
        </div>
    </template>

    <template id="projects-template">
        <div class="bg-gray-800 p-8 rounded-lg shadow-lg">
            <div id="evaluation-container">
                <div id="assessment-content">
                    <!-- Dynamic Assessment Content will be injected here -->
                </div>
                <div class="mt-6">
                    <button id="submit-evaluation-button" class="flex items-center justify-center rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 disabled:bg-gray-500 disabled:cursor-not-allowed">
                        <span id="submit-btn-text">Submit Assessment</span>
                        <div id="submit-spinner" class="spinner h-5 w-5 border-2 ml-3 hidden"></div>
                    </button>
                </div>
                <p id="evaluation-result" class="mt-4 text-center text-sm font-medium"></p>
            </div>
            <div id="projects-list-container" class="hidden">
                 <h1 class="text-3xl font-bold tracking-tight text-white">Available Projects</h1>
                 <p class="mt-2 text-gray-400">Congratulations on passing the evaluation. Here are the projects available to you.</p>
                 <ul id="projects-list" class="mt-6 grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
                    <!-- Project items will be injected here -->
                 </ul>
            </div>
        </div>
    </template>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signInWithPopup,
            GoogleAuthProvider,
            signOut,
            signInWithCustomToken,
            signInAnonymously,
            sendPasswordResetEmail
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            getDoc,
            setDoc,
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        // Use the configuration provided by the environment for a secure connection.
        const firebaseConfig = JSON.parse(
            typeof __firebase_config !== 'undefined' 
            ? __firebase_config 
            : '{}'
        );
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-outlier-help';

        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const loadingSpinner = document.getElementById('loading-spinner');
        const authSection = document.getElementById('auth-section');
        const dashboardSection = document.getElementById('dashboard-section');
        const authError = document.getElementById('auth-error');
        const toggleAuthLink = document.getElementById('toggle-auth');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const forgotPasswordForm = document.getElementById('forgot-password-form');

        // --- App State ---
        let currentUser = null;
        let isSignup = false;
        let isBgImageGenerated = false;

        // --- Setup Functions ---
        function setupPasswordToggle(inputId, toggleButtonId, eyeIconId, eyeSlashIconId) {
            const passwordInput = document.getElementById(inputId);
            const toggleButton = document.getElementById(toggleButtonId);
            const eyeIcon = document.getElementById(eyeIconId);
            const eyeSlashIcon = document.getElementById(eyeSlashIconId);

            toggleButton.addEventListener('click', () => {
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    eyeIcon.classList.add('hidden');
                    eyeSlashIcon.classList.remove('hidden');
                } else {
                    passwordInput.type = 'password';
                    eyeIcon.classList.remove('hidden');
                    eyeSlashIcon.classList.add('hidden');
                }
            });
        }

        // --- Authentication Logic ---
        async function initAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Initial authentication failed:", error);
            }
        }

        onAuthStateChanged(auth, async (user) => {
            const authBg = document.getElementById('auth-background-container');
            // Show dashboard only if user has an email (i.e., not an anonymous or initial token user)
            if (user && user.email) {
                currentUser = user;
                authSection.classList.add('hidden');
                dashboardSection.classList.remove('hidden');
                authBg.classList.add('opacity-0'); // Hide background
                document.getElementById('user-email').textContent = user.email;
                await main(); // Initialize dashboard
            } else {
                currentUser = null;
                authSection.classList.remove('hidden');
                dashboardSection.classList.add('hidden');
                authBg.classList.remove('opacity-0'); // Show background
                if (!isBgImageGenerated) {
                    generateBackgroundImage();
                    isBgImageGenerated = true;
                }
                // Setup password toggles when auth form is visible
                setupPasswordToggle('login-password', 'login-password-toggle', 'login-eye-icon', 'login-eye-slash-icon');
                setupPasswordToggle('signup-password', 'signup-password-toggle', 'signup-eye-icon', 'signup-eye-slash-icon');
            }
            loadingSpinner.classList.add('hidden');
        });
        
        // Toggle between login and signup forms
        toggleAuthLink.addEventListener('click', (e) => {
            e.preventDefault();
            isSignup = !isSignup;
            loginForm.classList.toggle('hidden', isSignup);
            signupForm.classList.toggle('hidden', !isSignup);
            toggleAuthLink.textContent = isSignup ? 'Already have an account? Sign in' : "Don't have an account? Sign up";
            authError.textContent = '';
        });

        document.getElementById('forgot-password-link').addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.classList.add('hidden');
            signupForm.classList.add('hidden');
            forgotPasswordForm.classList.remove('hidden');
            toggleAuthLink.classList.add('hidden'); // Hide the signup toggle
            authError.textContent = '';
        });

        document.getElementById('back-to-login-link').addEventListener('click', (e) => {
            e.preventDefault();
            forgotPasswordForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
            toggleAuthLink.classList.remove('hidden'); // Show the signup toggle
            authError.textContent = '';
        });

        document.getElementById('login-button').addEventListener('click', async () => {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            authError.textContent = '';
            try {
                // This function securely communicates with the Firebase backend.
                // It automatically handles the check to confirm if the user exists
                // and if the provided password is correct.
                // If the login is unsuccessful (user not found, wrong password),
                // it throws an error which is caught by the 'catch' block below.
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                // Display the error message returned from Firebase.
                authError.textContent = error.message;
            }
        });

        document.getElementById('signup-button').addEventListener('click', async () => {
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            authError.textContent = '';
            try {
                await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) {
                authError.textContent = error.message;
            }
        });

        document.getElementById('send-reset-button').addEventListener('click', async () => {
            const email = document.getElementById('reset-email').value;
            authError.textContent = '';
            try {
                await sendPasswordResetEmail(auth, email);
                authError.textContent = 'Password reset email sent! Check your inbox.';
                authError.classList.remove('text-red-400');
                authError.classList.add('text-green-400');
            } catch (error) {
                authError.textContent = error.message;
                authError.classList.add('text-red-400');
                authError.classList.remove('text-green-400');
            }
        });

        document.getElementById('google-signin-button').addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            authError.textContent = '';
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                authError.textContent = error.message;
            }
        });
        
        document.getElementById('signout-button').addEventListener('click', () => {
            signOut(auth);
        });
        
        
        // --- Dashboard Logic ---
        async function main() {
            const navLinks = document.querySelectorAll('.nav-link');
            const pageContent = document.getElementById('page-content');
            
            function updateActiveLink(hash) {
                navLinks.forEach(link => {
                    if (link.hash === hash) {
                        link.classList.add('bg-gray-900', 'text-white');
                        link.classList.remove('text-gray-300', 'hover:bg-gray-700');
                    } else {
                        link.classList.remove('bg-gray-900', 'text-white');
                        link.classList.add('text-gray-300', 'hover:bg-gray-700');
                    }
                });
            }
            
            async function loadContent() {
                const hash = window.location.hash || '#about';
                updateActiveLink(hash);
                let templateId;
                switch(hash) {
                    case '#menu':
                        templateId = 'menu-template';
                        break;
                    case '#projects':
                        templateId = 'projects-template';
                        break;
                    case '#about':
                    default:
                        templateId = 'about-template';
                        break;
                }
                const template = document.getElementById(templateId);
                pageContent.innerHTML = template.innerHTML;

                if (hash === '#projects') {
                    await setupProjectsPage();
                }
            }
            
            window.addEventListener('hashchange', loadContent);
            await loadContent(); // Initial load
        }
        
        // --- Projects Page Logic ---
        const assessments = [
            {
                prompt: "Explain the concept of 'machine learning' to a 5-year-old.",
                responseA: "It's when computers learn from looking at lots of pictures and numbers, like how you learn from looking at picture books, to get smarter at guessing things.",
                responseB: "Machine learning is a subfield of artificial intelligence that utilizes algorithms to analyze data, learn from it, and then make a determination or prediction about something new.",
                expertHint: "Response A is better. It uses a simple analogy (picture books) suitable for a 5-year-old, avoiding technical jargon. Response B is too complex and technical for the target audience."
            },
            {
                prompt: "Write a short, exciting opening sentence for a story about a space pirate.",
                responseA: "The notorious Captain Valerius boarded the starliner.",
                responseB: "The alarms screamed through the corridors of the starship *Celestial Dream* the moment Captain Kaelen's magnetic boots slammed onto the bridge, his laughter echoing in the sudden silence.",
                expertHint: "Response B is significantly better. It uses strong verbs ('screamed', 'slammed'), sensory details (alarms, laughter), and creates immediate action and character, which is more exciting."
            },
            {
                prompt: "What are three key benefits of switching to renewable energy sources?",
                responseA: "Switching to renewable energy helps the planet. It makes the air cleaner for us to breathe, doesn't run out like gas, and can create new jobs for people building windmills and solar panels.",
                responseB: "The primary benefits are: 1) Environmental protection through reduced greenhouse gas emissions. 2) Energy security by diversifying away from finite fossil fuels. 3) Economic advantages via job creation in the green sector.",
                expertHint: "Both are good, but Response A is slightly better for general audiences as it's more conversational and less jargon-heavy ('helps the planet', 'cleaner air'). Response B is more formal and academic. A good justification could argue for either, but must recognize the tonal difference."
            },
            {
                prompt: "Provide a two-sentence horror story.",
                responseA: "I woke up to hear knocking on the glass. At first, I thought it was the window until I heard it come from the mirror again.",
                responseB: "The last thing I saw was my alarm clock flashing 12:07 before she pushed her long rotting nails through my chest, her other hand muffling my screams. I sat bolt upright, relieved it was only a dream, but as I saw my alarm clock read 12:06, I heard my closet door creak open.",
                expertHint: "Both are classic horror tropes. Response B is arguably better as it builds more suspense and has a more complex narrative structure with the false relief moment. A good justification should point this out."
            },
            {
                prompt: "Summarize the plot of 'Hamlet' in one sentence.",
                responseA: "A young prince of Denmark, Hamlet, feigns madness to exact revenge on his uncle, who he believes murdered his father to seize the throne and marry his mother.",
                responseB: "Hamlet is a tragedy by William Shakespeare about a prince who sees his father's ghost and then spends the rest of the play trying to decide if he should kill his uncle, which leads to everyone dying.",
                expertHint: "Response A is better. It is a more formal and complete summary, capturing the core elements (revenge, feigned madness, usurpation) concisely. Response B is too colloquial and its ending ('leads to everyone dying') is an oversimplification, although not entirely inaccurate."
            }
        ];
        let currentAssessmentIndex = 0;


        async function setupProjectsPage() {
            const evaluationContainer = document.getElementById('evaluation-container');
            const projectsListContainer = document.getElementById('projects-list-container');
            
            // Check if user has already passed all assessments
            const userProgressRef = doc(db, `artifacts/${appId}/users/${currentUser.uid}/progress`, 'evaluation');
            const docSnap = await getDoc(userProgressRef);

            if (docSnap.exists() && docSnap.data().assessments_passed === true) {
                showProjects();
                return;
            }

            // If not passed, start the assessment process
            evaluationContainer.classList.remove('hidden');
            projectsListContainer.classList.add('hidden');
            renderCurrentAssessment();

            const submitButton = document.getElementById('submit-evaluation-button');
            submitButton.addEventListener('click', handleAssessmentSubmission);
        }
        
        function renderCurrentAssessment() {
            const assessment = assessments[currentAssessmentIndex];
            const contentEl = document.getElementById('assessment-content');
            
            contentEl.innerHTML = `
                <h2 class="text-xl font-bold tracking-tight text-white">Assessment ${currentAssessmentIndex + 1} of ${assessments.length}</h2>
                <p class="mt-2 text-gray-400">Read the prompt and the two AI responses. Rate which response is better and justify your answer.</p>
                
                <div class="mt-6 p-4 bg-gray-700 rounded-lg">
                    <h3 class="font-semibold text-indigo-300">Prompt:</h3>
                    <p class="mt-1 text-white">"${assessment.prompt}"</p>
                </div>

                <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="p-4 bg-gray-900/50 rounded-lg border border-gray-600">
                        <h4 class="font-semibold text-gray-300">Response A</h4>
                        <p class="mt-2 text-gray-300">${assessment.responseA}</p>
                    </div>
                    <div class="p-4 bg-gray-900/50 rounded-lg border border-gray-600">
                        <h4 class="font-semibold text-gray-300">Response B</h4>
                        <p class="mt-2 text-gray-300">${assessment.responseB}</p>
                    </div>
                </div>

                <div class="mt-6">
                    <h3 class="font-semibold text-white">1. Which response is better? (1 = A is much better, 5 = B is much better)</h3>
                    <fieldset class="mt-2">
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-400">A</span>
                            <div class="flex items-center space-x-2">
                                ${[1,2,3,4,5].map(rating => `
                                <label for="rating-${rating}" class="relative flex items-center justify-center rounded-full w-10 h-10 bg-gray-700 hover:bg-gray-600 cursor-pointer transition-colors">
                                    <input type="radio" name="rating" id="rating-${rating}" value="${rating}" class="peer absolute opacity-0">
                                    <span class="text-white peer-checked:text-indigo-300 peer-checked:font-bold">${rating}</span>
                                </label>
                                `).join('')}
                            </div>
                            <span class="text-sm text-gray-400">B</span>
                        </div>
                    </fieldset>
                </div>
                
                <div class="mt-6">
                    <h3 class="font-semibold text-white">2. Justify your rating:</h3>
                    <textarea id="assessment-justification" rows="4" class="mt-2 block w-full rounded-md border-0 bg-gray-900 p-3 text-white placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-500 sm:text-sm" placeholder="Explain your reasoning here..."></textarea>
                </div>
            `;
        }

        async function handleAssessmentSubmission() {
            const selectedRating = document.querySelector('input[name="rating"]:checked');
            const justification = document.getElementById('assessment-justification').value.trim();
            const resultEl = document.getElementById('evaluation-result');

            if (!selectedRating) {
                resultEl.textContent = 'Please select a rating from 1 to 5.';
                resultEl.className = 'mt-4 text-center text-sm font-medium text-red-400';
                return;
            }
            if (justification.length < 15) {
                resultEl.textContent = 'Please provide a more detailed justification (at least 15 characters).';
                resultEl.className = 'mt-4 text-center text-sm font-medium text-red-400';
                return;
            }

            const submitButton = document.getElementById('submit-evaluation-button');
            const submitBtnText = document.getElementById('submit-btn-text');
            const submitSpinner = document.getElementById('submit-spinner');
            
            submitButton.disabled = true;
            submitBtnText.textContent = 'Grading...';
            submitSpinner.classList.remove('hidden');
            resultEl.textContent = '';

            try {
                const aiResult = await gradeWithAI(assessments[currentAssessmentIndex], selectedRating.value, justification);

                if (aiResult.passed) {
                    currentAssessmentIndex++;
                    if (currentAssessmentIndex >= assessments.length) {
                        // Passed all assessments
                        resultEl.textContent = 'Congratulations! You have passed all assessments.';
                        resultEl.className = 'mt-4 text-center text-sm font-medium text-green-400';
                        const userProgressRef = doc(db, `artifacts/${appId}/users/${currentUser.uid}/progress`, 'evaluation');
                        await setDoc(userProgressRef, { assessments_passed: true });
                        setTimeout(showProjects, 2000);
                    } else {
                        // Move to next assessment
                        resultEl.textContent = 'Correct! Moving to the next assessment.';
                        resultEl.className = 'mt-4 text-center text-sm font-medium text-green-400';
                        setTimeout(() => {
                            resultEl.textContent = '';
                            renderCurrentAssessment();
                        }, 1500);
                    }
                } else {
                    resultEl.innerHTML = `Incorrect. The AI grader provided this feedback: <br/><em>"${aiResult.reason}"</em>. Please re-evaluate and try again.`;
                    resultEl.className = 'mt-4 text-center text-sm font-medium text-red-400';
                }
            } catch (error) {
                console.error('AI Grading Error:', error);
                resultEl.textContent = 'An error occurred during grading. Please try again later.';
                resultEl.className = 'mt-4 text-center text-sm font-medium text-red-400';
            } finally {
                submitButton.disabled = false;
                submitBtnText.textContent = 'Submit Assessment';
                submitSpinner.classList.add('hidden');
            }
        }


        function showProjects() {
            document.getElementById('evaluation-container').classList.add('hidden');
            const projectsListContainer = document.getElementById('projects-list-container');
            projectsListContainer.classList.remove('hidden');

            const allProjects = [ 
                { name: "Space Camelid" }, { name: "Metro Silo" }, { name: "Valkyrie" }, { name: "Stratus Drake" }, 
                { name: "Rhind Evals" }, { name: "Blueberry Bagels" }, { name: "Cloud Evals" }, { name: "S Knees Man" }, 
                { name: "Mascara Mambo" }, { name: "Glue Sail" }, { name: "Bettascope Rubrics" }, 
                { name: "Multilingual Static Comparison v2" }, { name: "Cloud Evals V3" }, { name: "Cypher Evals V3" }, 
                { name: "Summer Robin" }, { name: "Big Mallet" } 
            ];
            
            const listElement = document.getElementById('projects-list');
            listElement.innerHTML = ''; // Clear previous list
            allProjects.forEach(project => {
                const li = document.createElement('li');
                li.className = "col-span-1 flex flex-col divide-y divide-gray-600 rounded-lg bg-gray-700 text-center shadow transition hover:scale-105";
                li.innerHTML = `
                    <div class="flex flex-1 flex-col p-8 justify-center">
                        <h3 class="text-sm font-medium text-white">${project.name}</h3>
                    </div>
                `;
                listElement.appendChild(li);
            });
        }

        async function gradeWithAI(assessment, userRating, userJustification) {
             const apiKey = ""; // Canvas will provide this
             const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const systemPrompt = `You are an expert AI system that grades a junior evaluator's work.
            You will be given an 'expertHint' that contains the correct reasoning.
            You must evaluate if the junior evaluator's rating and justification align with the expertHint.
            The user's rating is on a scale of 1-5, where 1 means Response A is much better, and 5 means Response B is much better. A 3 is neutral.

            Your response MUST be in JSON format.
            - If the user's logic is sound and aligns with the expert hint, return: {"passed": true, "reason": "The user's reasoning is sound."}
            - If the user's logic is flawed, their rating is incorrect, or they miss the key points from the expert hint, return: {"passed": false, "reason": "A brief, helpful explanation for why they were wrong. For example: 'Your justification missed the key point that Response B was too technical for the audience.'"}
            
            Be strict but fair. The user doesn't have to match the hint word-for-word, but their core reasoning must be correct.
            Do not add any other text outside the JSON object.
            `;
            
            const userQuery = `
                Expert Hint: "${assessment.expertHint}"
                ---
                User's Rating (1-5): ${userRating}
                User's Justification: "${userJustification}"
            `;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                }
            };
            
            // Exponential backoff for retries
            let response;
            let attempts = 0;
            const maxAttempts = 5;
            while(attempts < maxAttempts) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) break;
                } catch (error) {
                    console.error(`Attempt ${attempts + 1} failed`, error);
                }
                attempts++;
                await new Promise(res => setTimeout(res, Math.pow(2, attempts) * 1000));
            }
            
            if (!response || !response.ok) {
                 throw new Error('AI service is unavailable after multiple retries.');
            }

            const result = await response.json();
            const jsonString = result.candidates[0].content.parts[0].text;
            return JSON.parse(jsonString);
        }

        async function generateBackgroundImage() {
            const bgImage = document.getElementById('auth-bg-image');
            const bgContainer = document.getElementById('auth-background-container');
            const apiKey = ""; // Canvas will provide this
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;

            const prompt = "A modern, abstract background with flowing indigo and dark gray lines, minimalist digital art, cinematic lighting.";

            const payload = {
                contents: [{
                    parts: [{ text: prompt }]
                }],
                generationConfig: {
                    responseModalities: ['IMAGE']
                },
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }
                const result = await response.json();
                const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                
                if (base64Data) {
                    bgImage.src = `data:image/png;base64,${base64Data}`;
                } else {
                    throw new Error('No image data found in response.');
                }
            } catch (error) {
                console.error("Background image generation failed:", error);
                // If generation fails, the background will remain the default dark gray.
            }
        }

        // --- App Initialization ---
        initAuth();

    </script>
</body>
</html>



